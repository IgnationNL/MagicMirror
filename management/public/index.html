<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Load scripts -->
  <script src="https://code.jquery.com/jquery-3.3.1.js"></script>

  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>

  <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/locale/nl.js"></script>

  <!-- eof: Load scripts -->

  <!-- Load CSS files -->
  <link rel="icon" href="favicon.ico" />

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.1/css/bootstrap.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap4.min.css">
  <!-- eof: Load CSS files -->
</head>

<body>
  <!-- Image and text -->
  <nav class="navbar navbar-light bg-light" style="margin-bottom:20px;">
    <a class="navbar-brand" href="#">
      <img src="ignation_logo.svg" width="30" height="30" class="d-inline-block align-top" alt="">
      M3 by Ignation
    </a>

    <form class="form-inline">
      <button id="ig-add-button" class="btn btn-outline-success" type="button" onClick="$('#ig-modal-create').modal('show');"><i class="fa fa-plus"></i> New user</button>
      <button id="ig-delete-button" class="btn btn-outline-danger" type="button" onClick="deleteFilesConfirmation()" disabled><i class="fa fa-trash"></i> Delete</button>
      <button id="ig-delete-privacy" class="btn btn-outline-primary" type="button" onClick="$('#ig-modal-privacy-notice').modal('show');"><i class="fa fa-info"></i> Privacy</button>
  </form>
  </nav>

  <div class="container">
    <div class="row">
      <div class="col-md">

        <div id="ig-load-screen">
          <img id="ig-modal-file-preview-image" src="load-icon.gif" class="rounded mx-auto d-block" alt="..." style="width:200px;height:200px;margin-bottom:-40px;">
          <h4 style="text-align:center">Loading data...</h4>
      </div>

      <div id="ig-main-content" style="display:none">
        <table id="ig-datagrid" class="table table-striped table-bordered" style="width:100%">
          <thead>
            <tr>
              <th></th>
              <th>Name</th>
              <th>Key</th>
              <th>Last Modified</th>
              <th>Is Indexed</th>
              <th>Options</th>
            </tr>
          </thead>
        </table>
      </div>

      </div>
    </div>
  </div>



  <!-- Modals -->
  <!-- Delete modal -->
  <div class="modal fade" id="ig-modal-delete-confirmation" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="ig-modal-delete-confirmation-title">Delete</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Cancel">
          <span aria-hidden="true">&times;</span>
        </button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete the selected items?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" id="ig-btn-delete-yes" class="btn btn-danger" data-dismiss="modal" onClick="deleteFiles()">Yes</button>
        </div>
      </div>
    </div>
  </div>
  <!-- eof: Delete modal -->

  <!-- File preview modal -->
  <div class="modal fade" id="ig-modal-file-preview" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="ig-modal-file-preview-title">File Preview</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close" onClick="didClosePreviewModal()">
        <span aria-hidden="true">&times;</span>
      </button>
        </div>
        <div class="modal-body">
          <img id="ig-modal-file-preview-image" src="load-icon.gif" class="rounded mx-auto d-block" alt="..." style="width:250px;height:250px">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal" onClick="didClosePreviewModal()">Close</button>
        </div>
      </div>
    </div>
  </div>
  <!-- eof: File preview modal -->

  <!-- Privacy notice modal -->
  <div class="modal fade" id="ig-modal-privacy-notice" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="ig-modal-privacy-notice-title">Privacy notice</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
        </div>
        <div class="modal-body">
          By using this tool you agree to the following:
          <ul>
              <li>Pictures you upload will be stored and processed by Amazon Webservices.</li>
              <li>Amazon face recognition technology is used to identify, store and process faces.</li>

              <li>IBM Cloud is used to process data, no personally identifiable information is stored however.</li>
              <li>You have received consent from each user you'll add to the management tool.</li>
              <li>Upon request by your customer, you will remove the user data from the M3 tool.</li>
              <li>It could be possible that data is stored and processed outside of the Netherlands.</li>
              <li>You take safeguards in order to prevent any abuse or misuse on your account</li>
              <li>Ignation reserves the right to take down the M3 tool without notice if any of the above gets violated.</li>
          </ul>


        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  <!-- eof: Privacy notice modal -->

  <!-- Create file modal -->
  <div class="modal fade" id="ig-modal-create" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="ig-modal-create-title">New User</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close" onClick="didCloseCreateModal()">
          <span aria-hidden="true">&times;</span>
        </button>
        </div>
        <div class="modal-body">

          <div id="ig-modal-create-alert" class="alert alert-primary" role="alert" style="display:none">
            Please wait while we process your request.
          </div>

          <form>
            <div class="form-group">
              <label for="ig-modal-create-name">Name</label>
              <input type="text" class="form-control" id="ig-modal-create-name" placeholder="Enter name of user">
              <small>This name is used to identify and greet the user.</small>
            </div>
            <div class="form-group">
              <label for="ig-modal-create-file">Face image</label>
              <input type="file" class="form-control-file" id="ig-modal-create-file">
              <small>We recommend choosing a photo in which only one face is visible.</small>
            </div>

            <div class="form-group" id="ig-form-group-modal-create-preview" style="display:none">
              <label for="ig-modal-create-preview">Preview</label>
              <img id="ig-modal-create-preview" class="rounded mx-auto d-block" alt="..." style="width:250px;height:250px">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal" onClick="didCloseCreateModal()">Cancel</button>
          <button type="button" id="ig-btn-create" class="btn btn-primary" onClick="createFile()">Create</button>
        </div>
      </div>
    </div>
  </div>

  <canvas id="canvas">
  <!-- eof: Create file modal -->

  <!-- eof: Modals -->

  <script>
    /******************************** INITIALISERS ********************************/
    var selectedFiles = [];

    $("#ig-modal-create-file").change(function() {
      showPreviewForFileUpload(this);
    });

    $(document).ready(function() {
      //apiLoadFaces();
      //$('#ig-modal-create').modal('show');

      getFiles();
    });
    /******************************** eof: INITIALISERS ********************************/

    /******************************** HELPER METHODS ********************************/


    /*** createFile() ***
     *
     *   Makes the API call for creating a file and updates the interface accordingly.
     */
    function createFile() {
      var name = $("#ig-modal-create-name").val();
      var file = $("#ig-modal-create-file").get(0).files;

      if (!name || name.length === 0) {
        alert("Name cannot be empty");

        return;
      }

      if (!file || file.length < 1) {
        alert("Please choose a file.");

        return;
      }

      $("#ig-btn-create").prop("disabled", true);

      // Show feedback to user.
      $("#ig-modal-create-alert").html("Please wait, your request is being processed...");
      $("#ig-modal-create-alert").removeClass("alert-primary alert-success alert-danger");
      $("#ig-modal-create-alert").addClass("alert-primary");

      $("#ig-modal-create-alert").show();

      apiCreateFile(name, file[0], function(err, resp) {
        $("#ig-modal-create-alert").removeClass("alert-primary alert-success alert-danger")

        var userMessage = "";
        if (err) {
          userMessage = err;
          $("#ig-modal-create-alert").addClass("alert-danger");
        } else {
          userMessage = resp;
          $("#ig-modal-create-alert").addClass("alert-success");
        }

        $("#ig-modal-create-alert").html(userMessage);

        $("#ig-btn-create").prop("disabled", false);

        getFiles();
      });
    }

    /*** showPreviewForFileUpload() ***
     *
     *   Function that is called when the file input attribute changes. Used to show a preview of the image.
     *
     *   @param input the file input element
     */
    function showPreviewForFileUpload(input) {
      if (input.files && input.files[0]) {
        var reader = new FileReader();

        reader.onload = function(e) {
          $('#ig-modal-create-preview').attr('src', e.target.result);
          $("#ig-form-group-modal-create-preview").show();
        }

        reader.readAsDataURL(input.files[0]);
      }
    }

    /*** didToggleCheckbox() ***
     *
     *   Function that is called when a checkbox in a row got toggled. Will save the state of selected faceIds.
     *
     *    @param faceId the ID of the face that got toggled.
     */
    function didToggleCheckbox(faceId) {
      //console.log("did toggle: " + faceId);

      if (selectedFiles.includes(faceId)) {
        selectedFiles.splice(selectedFiles.indexOf(faceId), 1);
      } else {
        selectedFiles.push(faceId);
      }

      $("#ig-delete-button").prop("disabled", !(selectedFiles.length > 0));
    }

    /*** deleteFilesConfirmation() ***
     *
     *   Asks user confirmation for deleting the selected files.
     */
    function deleteFilesConfirmation() {
      if (selectedFiles.length > 0) { // Only show model when there are items selected.
        $('#ig-modal-delete-confirmation').modal('show');
      }
    }

    /*** deleteFiles() ***
     *
     *   Deletes the selected files and updates the interface accordingly.
     */
    function deleteFiles() {
      if (selectedFiles.length === 0) {
        return;
      }

      $("#ig-btn-delete-yes").prop("disabled", true); // disable delete button


      // Delete file and restore button settings
      apiDeleteFiles(selectedFiles, function(err, resp) {
        if (err) {
          alert("Cannot delete files. Try refreshing the page. Error message: " + err)
          return;
        }

        selectedFiles = [];
        $("#ig-btn-delete-yes").prop("disabled", false);
        $("#ig-delete-button").prop("disabled", true);

        $('#ig-modal-delete-confirmation').modal('hide');

        // Reload files
        getFiles();
      });
    }

    /*** getFiles() ***
     *
     *   Retrieves the files from the server and shows it in the interface accordingly.
     */
    function getFiles() {
      $("#ig-main-content").hide();
      $("#ig-load-screen").show();

      apiGetFiles(function(err, resp) {
        $("#ig-main-content").show();
        $("#ig-load-screen").hide();

        if (err) {
          alert("Cannot load files. Try refreshing the page. Error message: " + err)
          return;
        }

        $('#ig-datagrid').DataTable().clear().draw();

        // Add data to table.
        for (var i = 0; i < resp.Contents.length; i++) {
          var file = resp.Contents[i];
          var name = atob(file.Key.substring(13));


          $('#ig-datagrid').DataTable().row.add(["<input type=\"checkbox\" id=\"ig-checkbox-" + file.Key + "\" onClick=\"didToggleCheckbox('" + file.Key +
          "')\">",
            name, file.Key, moment(file.LastModified).fromNow(), file.isIndexed, "<button type=\"button\" class=\"btn btn-outline-primary\" onClick=\"showFilePreview('" + file.Key + "')\"><i class=\"fa fa-eye\"></i> Preview</button>"
          ]).draw(false);
        }
      });
    }

    /*** didCloseCreateModal() ***
     *
     *   Clears the create modal dialog of all entered input. Should be called when modal gets closed.
     *
     */
    function didCloseCreateModal() {
      $("#ig-modal-create-name").val("");
      $("#ig-modal-create-file").val("");
      $("#ig-modal-create-preview").attr("src", "");
      $("#ig-form-group-modal-create-preview").hide();

      $("#ig-modal-create-alert").hide();
    }

    /*** didClosePreviewModal() ***
     *
     *   Clears the preview modal dialog of all entered input. Should be called when modal gets closed.
     *
     */
    function didClosePreviewModal() {
      $("#ig-modal-file-preview-image").attr("src", "load-icon.gif");
    }

    /*** showFilePreview() ***
     *
     *   Retrieves and displays the image file for the specified key
     *
     *   @param key the ID of the file to be retrieved
     *   @param callback callback in the form of (err, resp) that will be called upon completion
     */
    function showFilePreview(key) {
      if (!key) {
        return;
      }
      $("#ig-modal-file-preview-image").attr("src", "load-icon.gif");
      $('#ig-modal-file-preview').modal('show');

      apiShowFilePreview(key, function(err, resp) {
        // We're not updating the UI here, because memory buffer runs out. Decode code is performed in the API method itself.
      });
    }

    /******************************** eof: HELPER METHODS ********************************/

    /******************************** API CALLS ********************************/

    /*** apiCreateFile() ***
     *
     *   API call for creating a file
     *
     *   @param name the name of the new file.
     *   @param file the file containing an image of the face
     *   @param callback callback in the form of (err, resp) that will be called upon completion
     */
    function apiCreateFile(name, file, callback) {
      if (!name || !file) {
        return;
      }

      var formData = new FormData();
      formData.append("faceImage", file);
      formData.append("name", name)

      var xmlHttp = new XMLHttpRequest();
      xmlHttp.onreadystatechange = function() {
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
          var response = JSON.parse(xmlHttp.responseText);
          callback(response.err, response.resp);
        }
      }
      xmlHttp.open("POST", "/file", true);
      xmlHttp.send(formData);
    }

    /*** apiGetFiles() ***
     *
     *   API call for retrieving files.
     *
     *   @param callback callback in the form of (err, resp) that will be called upon completion
     */
    function apiGetFiles(callback) {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.onreadystatechange = function() {
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
          var response = JSON.parse(xmlHttp.responseText);

          callback(response.err, response.resp);
        }
      }
      xmlHttp.open("GET", "/files", true);
      xmlHttp.send(null);
    }

    /*** apiShowFilePreview() ***
     *
     *   API call for retrieving the image file for the specified key
     *
     *   @param key ID of the file to be retrieved
     *   @param callback callback in the form of (err, resp) that will be called upon completion
     */
    function apiShowFilePreview(key, callback) {

      if (!key) {
        return;
      }

      var params = {
        "key": key
      };

      var xmlHttp = new XMLHttpRequest();

      xmlHttp.onreadystatechange = function() {
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
          var response = JSON.parse(xmlHttp.responseText);

          // Note: We're processing the response here, rather than in the callback. This is because calling the callback with the image buffer runs out memory.
          if (response.err) {
            alert("Cannot load image. Try refreshing the page. Error message: " + JSON.stringify(err));
            return;
          }

          // Decode image
          var b64encoded = btoa(String.fromCharCode.apply(null, response.resp.Body.data));
          var datajpg = "data:image/jpg;base64," + b64encoded;

          $("#ig-modal-file-preview-image").attr("src", datajpg);
          // eof: Decode image
return;
          callback(null, null); // Call callback, but we don't do anything there.
        }
      }
      xmlHttp.open("POST", "/file/preview", true);
      xmlHttp.setRequestHeader("Content-type", "application/json");
      xmlHttp.send(JSON.stringify(params));
    }

    /*** apiDeleteFile() ***
     *
     *   API call for deleting the file specified by keys.
     *
     *   @param keys IDs of the files to be removed.
     *   @param callback callback in the form of (err, resp) that will be called upon completion
     */
    function apiDeleteFiles(keys, callback) {

      if (!keys) {
        return;
      }
      var params = {
        "keys": keys
      };

      var xmlHttp = new XMLHttpRequest();

      xmlHttp.onreadystatechange = function() {
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
          var response = JSON.parse(xmlHttp.responseText);

          callback(response.err, response.resp);
        }
      }
      xmlHttp.open("DELETE", "/files", true);
      xmlHttp.setRequestHeader("Content-type", "application/json");
      xmlHttp.send(JSON.stringify(params));
    }

    /******************************** eof: API CALLS ********************************/
  </script>
</body>

</html>
